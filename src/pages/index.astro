---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Calculadora de Riesgo de Ataque al Corazón">
  <div class="flex min-h-screen flex-col lg:flex-row">
    <aside
      class="w-full lg:w-[400px] bg-white shadow-vercel flex flex-col border-b lg:border-r border-accent-2 p-5 space-y-8"
    >
      <div class="border-b border-accent-2">
        <h1 class="text-xl font-semibold text-primary tracking-tight">
          Calculadora de Riesgo de Ataque al Corazón
        </h1>
      </div>
      <div class="overflow-y-auto flex-1 mt-6 lg:mt-0">
        <form class="space-y-5">
          <div>
            <label class="flex items-center cursor-pointer">
              <input
                type="checkbox"
                name="angina"
                class="w-4 h-4 text-primary border-accent-2 rounded focus:ring-primary"
              />
              <span class="ml-2 text-sm">¿Tuviste angina?</span>
            </label>
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              ¿Cuál es tu rango de edad? <span class="text-error">*</span>
            </label>
            <select
              name="age"
              required
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            >
              <option value="">Selecciona una opción</option>
              <option value="Age 80 or older">Edad 80 o más</option>
              <option value="Age 75 to 79">Edad 75 a 79</option>
              <option value="Age 70 to 74">Edad 70 a 74</option>
              <option value="Age 65 to 69">Edad 65 a 69</option>
              <option value="Age 60 to 64">Edad 60 a 64</option>
              <option value="Age 55 to 59">Edad 55 a 59</option>
              <option value="Age 50 to 54">Edad 50 a 54</option>
              <option value="Age 45 to 49">Edad 45 a 49</option>
              <option value="Age 40 to 44">Edad 40 a 44</option>
              <option value="Age 35 to 39">Edad 35 a 39</option>
              <option value="Age 30 to 34">Edad 30 a 34</option>
              <option value="Age 25 to 29">Edad 25 a 29</option>
              <option value="Age 18 to 24">Edad 18 a 24</option>
            </select>
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              Peso en Kilogramos <span class="text-error">*</span>
            </label>
            <input
              type="number"
              name="weight"
              required
              min="1"
              step="0.1"
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            />
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              ¿Cómo describirías tu salud general? <span class="text-error"
                >*</span
              >
            </label>
            <select
              name="health"
              required
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            >
              <option value="">Selecciona una opción</option>
              <option value="Excellent">Excelente</option>
              <option value="Very good">Muy buena</option>
              <option value="Good">Buena</option>
              <option value="Fair">Regular</option>
              <option value="Poor">Mala</option>
            </select>
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              Altura en Metros <span class="text-error">*</span>
            </label>
            <input
              type="number"
              name="height"
              required
              min="0.1"
              max="3"
              step="0.01"
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            />
          </div>

          <div>
            <label class="flex items-center cursor-pointer">
              <input
                type="checkbox"
                name="chest-scan"
                class="w-4 h-4 text-primary border-accent-2 rounded focus:ring-primary"
              />
              <span class="ml-2 text-sm">¿Tuviste un escáner de pecho?</span>
            </label>
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              Horas promedio de sueño <span class="text-error">*</span>
            </label>
            <input
              type="number"
              name="sleep"
              required
              min="0"
              max="24"
              step="0.5"
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            />
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              ¿Cuántos días en los últimos 30 días tu salud física no fue buena? <span
                class="text-error">*</span
              >
            </label>
            <input
              type="number"
              name="physical-health"
              required
              min="0"
              max="30"
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            />
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-secondary">
              ¿Cuántos días en los últimos 30 días tu salud mental no fue buena? <span
                class="text-error">*</span
              >
            </label>
            <input
              type="number"
              name="mental-health"
              required
              min="0"
              max="30"
              class="w-full px-3 py-2 text-sm bg-white border border-accent-2 rounded-md focus:ring-2 focus:ring-success focus:border-success"
            />
          </div>

          <div>
            <label class="flex items-center cursor-pointer">
              <input
                type="checkbox"
                name="stroke"
                class="w-4 h-4 text-primary border-accent-2 rounded focus:ring-primary"
              />
              <span class="ml-2 text-sm">¿Tuviste un derrame cerebral?</span>
            </label>
          </div>

          <button
            type="submit"
            class="w-full py-3 px-4 bg-black text-white text-sm font-medium rounded-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors"
          >
            Calcular Riesgo
          </button>
        </form>
      </div>
    </aside>

    <main class="flex-1 p-8">
      <div class="h-full flex items-center justify-center">
        <div class="text-center">
          <img id="risk-image" class="w-full sm:w-auto" width="400px" />
          <h2 class="mt-4 text-2xl font-medium text-primary" id="risk-text">
            Sin resultados aún
          </h2>
          <p class="mt-2 text-lg text-secondary" id="risk-description">
            Complete el formulario para ver los resultados
          </p>
        </div>
      </div>
    </main>
  </div>
</Layout>

<script is:inline>
  const riskImage = document.querySelector("#risk-image");
  const riskText = document.querySelector("#risk-text");
  const riskDescription = document.querySelector("#risk-description");

  document.querySelector("form").addEventListener("submit", async (event) => {
    event.preventDefault();

    const bmi = (weight, height) => weight / height ** 2;

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    const parsedData = [
      data.angina === "on" ? 1 : 0,
      data.age,
      bmi,
      data.weight,
      data.health,
      data.height,
      data["chest-scan"] ? 1 : 0,
      +data.sleep,
      +data["physical-health"],
      +data["mental-health"],
      data.stroke ? 1 : 0,
    ];

    const response = await fetch(
      "https://danielquinterocespedes.us-east-1.aws.modelbit.com/v1/predict_heart_attack/latest",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ data: parsedData }),
      }
    );

    const result = await response.json();
    const probability = result.data.probability[0][1];
    const probabilityPercentage = (probability * 100).toFixed(2);

    if (probability > 0.7) {
      riskImage.src = "/src/static/images/high_risk.webp";
      riskText.innerHTML = "Alto riesgo de ataque al corazón";
      riskImage.alt = "Alto riesgo";
    } else if (probability > 0.3) {
      riskImage.src = "/src/static/images/medium_risk.webp";
      riskText.innerHTML = "Riesgo moderado de ataque al corazón";
      riskImage.alt = "Riesgo moderado";
    } else {
      riskImage.src = "/src/static/images/low_risk.webp";
      riskText.innerHTML = "Bajo riesgo de ataque al corazón";
      riskImage.alt = "Bajo riesgo";
    }

    riskDescription.innerHTML = `Probabilidad: ${probabilityPercentage} %`;
  });
</script>
